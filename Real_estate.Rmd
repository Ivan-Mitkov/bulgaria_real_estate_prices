---
title: "Балонът в цените на недвижимите имоти"
subtitle: "Мит или реалност"
author: "Ivan Ivanov"
date: "2024-11-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE, warning = FALSE)
```
*"Трябва ли да купя сега, или ще сгреша? Всички около мен говорят, че цените само ще се вдигат – ами ако изпусна момента? Това „страх да не изтърва“ не ми дава мира. Но дали мисля рационално, или се поддавам на стадното мнение? Толкова хора купуват, сякаш не могат да загубят, но не беше ли така и преди кризите?
Може би прекалено оптимистично си мисля, че ще мога да плащам ипотека безпроблемно. Ами ако доходите ми се променят или лихвите тръгнат нагоре? Чувствам, че контролирам ситуацията, но дали не е просто илюзия за контрол? Всички казват, че недвижимите имоти са сигурна инвестиция – но дали това не е пристрастие към статуквото? Мисля, че купуването сега е правилно, само защото всички го правят, а не защото съм сигурен, че е най-доброто за мен.
Но от друга страна, плащам наем, а това изглежда като пари на вятъра. Ами ако изчакам и цените паднат? Но кой може да предвиди това? Страхът и несигурността ме карат да търся сигурност, но дали тази сигурност е само привидна?"*

Мислите, които описахме, демонстрират ключови концепции от поведенческите финанси, свързани с когнитивните пристрастия, социалните влияния и емоционалните фактори, които оформят икономическите решения. Нека разгледаме тези феномени:

### 1.	Страх от пропускане (FOMO):

Страхът, че цените ще продължат да се повишават и възможността за покупка ще се изплъзне, кара индивидите да вземат решения въз основа на емоции, а не рационален анализ. Това е типичен когнитивен капан в периоди на пазарен подем, когато мнозинството вярва в безкрайния ръст.

### 2.	Ефект на стадото:

Наблюдението, че „всички купуват“, създава социален натиск и усещане за сигурност, базирано на действията на другите. Хората често приемат, че групата разполага с повече информация. Ако "всички купуват" недвижими имоти, индивидът може да реши, че това е правилното действие, дори без доказателства. Това може да доведе до изкуствено търсене и покачване на цените. Ефектът на стадото е особено силен в условия на несигурност и масова еуфория или страх, което го прави ключов двигател на пазарните аномалии.  Желанието за социално одобрение и страхът от това да се откроиш или сгрешиш самостоятелно, карат хората да се съобразяват с груповите действия. Вместо да се направи собствен анализ, човекът може да се подведе по колективната ирационалност, която често води до балони.

### 3.	Пристрастие към оптимизъм:

Надценяването на способността за изплащане на ипотеката и игнорирането на рисковете (като бъдещо увеличение на лихвите) са класически прояви на прекомерен оптимизъм. Ситуацията на пазара на труда, също силно се влияе от моментното състояние. При дългогодишна експанзия сигурността за работата и възможностите за лесното и сменяне може доста да се надценяват. Това пристрастие кара хората да подценяват вероятността за неблагоприятни събития.

### 4.	Илюзия за контрол:

Усещането, че пазарът може да бъде „надхитрен“ чрез добро таймиране или избор на подходящ имот, е пример за когнитивна илюзия. Всъщност, пазарът на имоти е силно зависим от макроикономически фактори, които индивидуалният купувач не може да предвиди или контролира.

### 5.	Пристрастие към статуквото:

Недвижимите имоти се възприемат като „сигурна инвестиция“ поради традиционния им статус на стабилен актив. Това пристрастие кара хората да избират имоти дори при очевидни индикации за надценяване.

### 6.	Несигурност и търсене на сигурност:

Търсенето на сигурност е естествена реакция на несигурността. Хората се стремят да минимизират риска и да намерят стабилност. Това желание се проявява по различни начини:

####  Вземане на решения въз основа на познати модели:

Например, вярването, че „недвижимите имоти винаги поскъпват“ или че „собствеността е по-сигурна от наемането“.
	
#### Привързване към традиционни убеждения:

Имоти се разглеждат като "сигурно убежище" за спестяванията, дори ако икономическите условия предполагат надценяване.
	
#### Фокус върху краткосрочната стабилност:

Решенията се вземат, за да осигурят моментално спокойствие, дори ако дългосрочният анализ показва възможни негативни последици. Хората предпочитат да вземат решение сега, отколкото да чакат "перфектния момент", който може никога да не дойде.
	
Поведенческите пристрастия често изместват фокуса от икономическите основи към емоционални и социални фактори. За да избегнем тези капани, решението за покупка на имот трябва да се базира на балансиран анализ на личните финансови възможности, макроикономическите условия и дългосрочните цели, а не на краткосрочни емоции или социален натиск.

### Основните фактори определящи динамиката на цените на недвижимите имоти са:

##### Икономическият растеж, свързаните с него растеж на доходи, ниска безработица, по-ниско ниво на риск.

##### Лихвените проценти – нивата на лихвените проценти, както номиналните такива, така и реалните – т.е. след като се преизчислят през инфлацията.

##### Демографските промени.

За нуждите на по-краткосрочни решения **демографските промени** може да се разглеждат като относително ирелевантен фактор. Промените стават бавно, трябват десетилетия, за да окажат съществено влияние и във всеки един момент и във всяко едно решение тяхното влияние може да се разглежда като вече включено в цената. 

**Икономическият растеж**, сам по себе си, е доста обобщаващ фактор. Отделният човек го усеща, но по-скоро през косвените му проявления. Ръст на доходи, лекота на смяна на работа, усещане за сигурност за работата си и високи възможности за планиране. В последващия анализ ще се спрем основно на два от съпътстващите го фактори, които пряко се отразяват върху икономическото благосъстояние на хората, взимащи решения за покупка на недвижим имот. **Доходите и инфлацията**.

**Лихвените проценти** имат огромно значение за възможността купувача да реализира желанието си за покупка. Недвижимите имоти са извън възможностите средно статистически купувач да ги купи със спестени пари. Налага се да вземе кредит. Лихвения процент, особено при дългосрочните кредити – като ипотеки - изключително силно влияе на размерът на вноската по кредита. Можем да разгледаме лихвените проценти като номинални и като реални. Номиналният лихвен процент е това, което плащаме. Ниските номинални лихвени проценти определят до колко достъпен е даден кредит. Но реалният лихвен процент до голяма степен определя до колко е икономически издържан изборът да се купуват на кредит. 

Ако цените на недвижимите имоти растат заедно с инфлацията, а лихвените проценти по ипотеки са под нивата на инфлацията, то оскъпяването на апарартамента през годините ще е по-високо от заплащаната цена на кредита. Реалният лихвен процент ще е отрицателен или с други думи печелим от инфлацията на цените на недвижимите имоти повече, отколкото губим от лихва по кредит. Което е силен стимул за покупка сега и плащане в бъдеще. 


*Данните за долните графики са взети от НСИ за средната заплата в София, инфлацията в България и за индекса на цените на недвижимите имоти за София. Данните за лихвените проценти по ипотечни кредити са от БНБ. 
За графиките включващи плащания по ипотеки, цена на среден апартамент в София са правени собствени изчисления, като за среден апартамент се приема апартамент от 82 квадрата какъвто е средния апартамент в София към 2024, срокът на ипотеката е 25 години, а лихвата е средната лихва за съответната година. Данните са от 2008 г. насам, за предишни периоди липсват общо достъпни данни за един или повече от параметрите*

### Какво показват данните


```{r}

library(tidyverse)
library(readxl)
library(lubridate)
library(viridis)
library(scales)
```

```{r}
setwd("C:\\Users\\Ivan\\Documents\\DataAnalyst\\Bulgarian Real Estate Prices")

customTheme<- theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
            panel.background = element_rect(fill = NA, color = NA),
        panel.grid.major = element_line(color = "gray", size = 0.5),  # Major grid lines
        panel.grid.minor = element_blank(),
            legend.position = "bottom"

        )
virirdis_fill<-scale_fill_viridis(
    alpha = 0.8,
    discrete = TRUE,
    option = "C",
    aesthetics = "fill"
  )
viridis_color <-  scale_color_viridis(
  alpha = 0.8,
  discrete = TRUE,
  option = "C",
  aesthetics = "colour"
)

data_row <- read_excel("real_estate_data.xlsx")
#mutate dates to Date
data <- data_row%>%
  mutate(year=as.Date(year,format='%d.%m.%Y'))
```

```{r}
#pivot long
growth_df <- data%>%
  pivot_longer(cols=c(inflation_index,
               real_estate_index,
               average_salary_index),
               names_to = 'category',
               values_to = 'growth'
               )
ggplot(growth_df, aes(x = year, y = growth, fill = category)) +
  geom_area(
    data = subset(growth_df, category == "average_salary_index"),
    stat = "identity",
    position = position_dodge2(width=0.3,  preserve = "single")) +
  geom_area(
    data = subset(growth_df, category != "average_salary_index"),
    stat = "identity",
           position = position_dodge2(width=0.3,  preserve = "single")) +
 
  scale_fill_viridis(
    alpha = 0.8,
    discrete = TRUE,
    option = "C",
    aesthetics = "fill",
    labels=c("Индекс на растежа на средната работна заплата","Индекс на потребителските цени","Индекс на растежа на цените на недвижимите имоти")
  )+
  
  labs(
    title = "Сравнение на растежа на заплати, инфлация и цени на имоти",
    x = "Година",
    y = "Растеж, 2008 година = 100",
    fill = "",
    color = ""
  )+
   guides(
    fill = guide_legend(ncol = 1),  # For bar chart legend
    color = guide_legend(ncol = 1)  # For line chart legend
  ) +
  customTheme
```

От 2008г. растежът на средните доходи в София значително изпреварва ръстът на инфлацията или на цените на недвижимите имоти. В същото време, след първоначалния спад в цените на имотите първо задари световната финансова криза, а в последствие и заради европейската банкова криза, за целия период поскъпването на имотите е доста близо до инфлацията. Което предполага, че основно влияние върху поскъпването на имотите имат фундаментални икономически фактори, а не толкова ирационални причини. 

```{r}
# Step 1: Calculate the base year value (2010) for each category
base_year_values <- growth_df %>%
  filter(format(year, "%Y") == "2014") %>%
  group_by(category) %>%
  summarise(base_value = first(growth))

# Step 2: Rebase the data
rebased_df <- growth_df %>%
  left_join(base_year_values, by = "category") %>%
  mutate(rebased_growth = (growth / base_value) * 100)

# Step 3: Filter for years after 2010 for plotting
growth_after_2014 <- rebased_df %>%
  filter(year >= as.Date("2014-01-01"))


max_index_value<- max(growth_after_2014$rebased_growth, na.rm = TRUE)



ggplot(data=growth_after_2014, aes(x = year, y = rebased_growth, colour = category)) +
  scale_y_continuous(
    limits = c(90,300),
    breaks = seq( 0, 280, # Use entire dataset
                  by = 50
    ),
    expand = c(0, 0) # Remove extra padding)
  ) +
  geom_line(
    data = subset(growth_after_2014, category == "average_salary_index"),
    stat = "identity",
    size=1,
    position = position_dodge2(width=0.3,  preserve = "single")) +
 
  geom_line(
    data = subset(growth_after_2014, category == "real_estate_index"),
    stat = "identity",
    size=1,
    position = position_dodge2(width=0.3,  preserve = "single")) +
  geom_line(
    data = subset(growth_after_2014, category == "inflation_index"),
    stat = "identity",
    size=1,
    position = position_dodge2(width=0.3,  preserve = "single")) +
 scale_color_viridis(
    alpha = 0.8,
    discrete = TRUE,
    option = "C",
    aesthetics = "color",
    labels=c("Индекс на растежа на средната работна заплата", "Индекс на потребителските цени","Индекс на растежа на цените на недвижимите имоти")
  )+
  labs(
    title = "Сравнение на растежа на заплати, инфлация и цени на имоти",
    x = "Година",
    y = "Растеж, 2008 година = 100",
    fill = "",
    color = ""
  )+
   guides(
    fill = guide_legend(ncol = 1),  # For bar chart legend
    color = guide_legend(ncol = 1)  # For line chart legend
  ) +
  customTheme
```

Ситуацията се изменя донякъде ако разглеждаме само годините на ръст в цените на имотите или от 2015г. насам. Цените на имотите продължават да изостават значително от растежа на доходите, но същевременно изпреварват силно инфлацията. Можем да направим извод, че в годините на икономическа експанзия ръстът на доходите, а не толкова общото ценово равнище е двигател и на промяната в цените на апартаментите в София. Това създава известна опасност за надскачане на цените на имотите на техните реални стойности, особено ако растежът на доходите се запази за по-дълъг период. 

```{r}
growth_df <- data%>%
  pivot_longer(cols=c(inflation_growth,
               real_estate_index_growth,
               average_salary_growtth),
               names_to = 'category',
               values_to = 'growth'
               )

growth_number <- data%>%
  pivot_longer(cols=c(inflation_growth,
               real_estate_index_growth,
               average_salary_growtth),
               names_to = 'category',
               values_to = 'growth'
               )



ggplot(growth_df, aes(x = factor(year), y = growth, fill = category)) +
  geom_bar(stat = "identity",
           position = position_dodge2(width=0.1,  preserve = "single")) +
  scale_x_discrete(
    breaks = c('2008-12-31','2009-12-31','2010-12-31','2011-12-31','2012-12-31',
                       '2013-12-31','2014-12-31',
               '2015-12-31','2016-12-31','2017-12-31',
               '2018-12-31','2019-12-31','2020-12-31',
               '2021-12-31','2022-12-31','2023-12-31',
               '2024-03-31','2024-06-30'),
    # date_labels =c(replicate(15,'%Y'),'%month','%month'),
    expand = expansion(mult = c(0.01, 0.02)) # Ensure space for the quarterly points
  ) +
 scale_fill_viridis(
    alpha = 0.8,
    discrete = TRUE,
    option = "C",
    aesthetics = "fill",
    labels=c("Индекс на растежа на средната работна заплата","Индекс на потребителските цени","Индекс на растежа на цените на недвижимите имоти")
  )+
  labs(
    title = "Изменение по години",
    x = "Година",
    y = "Изменение",
    fill = "",
    color = ""
  )+
   guides(
    fill = guide_legend(ncol = 1),  # For bar chart legend
    color = guide_legend(ncol = 1)  # For line chart legend
  ) +
  customTheme

```

Ако разгледаме данните година по година, на пръв поглед прави впечатление доста сериозната волатилност в цените на имотите спрямо инфлацията и доходите. Въпреки че няма година, в която доходите да падат, цените на имотите спадат силно по време на периоди на несигурност. Нежеланието на банките да кредитират, усещането на несигурност в икономиката, стоенето на страна от рискови инвестиции в купувачите по-скоро с инвестиционни или спекулативни желания, много силно повлиява на пазарът на имоти. 

Тъй като доходите запазват положителното си изменение, може да се каже, че само ръст на заплатите не е достатъчен, за да се гарантира, че имотите ще растат. Дори и само с равнището на инфлацията. Нужна е и общо усещане за сигурност в икономиката и възможност за дългосрочно планиране.

```{r}
data_factor<- data%>%mutate(year=factor(year))
ggplot(data_factor, aes(x =year),) +
  # Bar chart for real_estate_index_growth
  geom_bar(aes(y = real_estate_index_growth*100, fill = "Ръст в цената"), 
           stat = "identity", position = position_dodge2(width=0.1,  preserve = "single")) + 
  geom_line(aes(y = average_interest_rate_mortgage, color = "Лихва по ипотеки (%)"), size = 1,group = 1) +
  geom_point(aes(y = average_interest_rate_mortgage , color = "Лихва по ипотеки (%)"), size = 2) +
  
  # Scales and secondary y-axis
  scale_y_continuous(
    name = "Ръст в цената (%)",
    limits = c(-30, 20), # Set limits for the left y-axis
    breaks = seq(-30, 20, by = 5), # Define breaks for the left y-axis
    sec.axis = sec_axis(~./1, name = "Лихва по ипотеки (%)"),
    expand = expansion(mult = c(-0.1, 0.1)) # Adds some space for better display
  ) +
  
  # Formatting for the x-axis
  scale_x_discrete(
    breaks = c('2008-12-31','2009-12-31','2010-12-31','2011-12-31','2012-12-31',
               '2013-12-31','2014-12-31',
               '2015-12-31','2016-12-31','2017-12-31',
               '2018-12-31','2019-12-31','2020-12-31',
               '2021-12-31','2022-12-31','2023-12-31',
               '2024-03-31','2024-06-30'),
    # date_labels =c(replicate(15,'%Y'),'%month','%month'),
    expand = expansion(mult = c(0.01, 0.02)) # Ensure space for the quarterly points
  ) +
  
  # Labels and titles
  labs(
    title = "Ръст на цените на недвижимите имоти и лихвен процент по ипотека",
    x = "Година",
    fill = "",
    color = ""
  ) +
  
 virirdis_fill+
 viridis_color+
 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )+
   guides(
    fill = guide_legend(ncol = 1),  # For bar chart legend
    color = guide_legend(ncol = 1)  # For line chart legend
  ) +
  customTheme
```

Лихвените проценти по ипотечни кредити в България бележат трайно намаление през последните години. Като се изключат годините на банкова криза в Европа, са и трайно под 5%. Освен като чиста цена на заемния капитал е очевидна и връзката между несигурност и съответно намалено желание за кредитиране в банките и подържане на високи лихви. А нежеланието на банките да кредитират пряко се отразява и на цените на имотите, като е почти невъзможен ръст в цените без достатъчно ипотечни кредити на ниска цена. 

```{r}
# growth_df2 <- data%>%
#   pivot_longer(cols=c(average_price_condo,
#                       mortgage_payment,
#                      ),
#                names_to = 'category',
#                values_to = 'value'
#   )%>%
#   mutate(
#     # Scale `average_price_condo` to align with the primary y-axis (0–100)
#     scaled_value = ifelse(category == "average_price_condo", value, value *200)
#   )
# # Plot with dual y-axes
# ggplot(growth_df2, aes(x = factor(year), fill = category)) +
#   geom_bar(
#     aes(y = scaled_value),
#     stat = "identity",
#     position = position_dodge2(width = 0.1, preserve = "single")
#   ) +
#   scale_x_discrete(
#     breaks = c(
#       '2008-12-31', '2009-12-31', '2010-12-31', '2011-12-31', '2012-12-31',
#       '2013-12-31', '2014-12-31', '2015-12-31', '2016-12-31', '2017-12-31',
#       '2018-12-31', '2019-12-31', '2020-12-31', '2021-12-31', '2022-12-31',
#       '2023-12-31', '2024-03-31', '2024-06-30'
#     ),
#     expand = expansion(mult = c(0.01, 0.02)) # Ensure space for the quarterly points
#   ) +
#   scale_y_continuous(
#     name = "Средна цена на апартамент €",  # Primary y-axis for `average_price_condo`
#     limits = c(0,200000),
#     sec.axis = sec_axis(~ . / 200,
#                         name = "Вноска по ипотека €",
#                        )  # Secondary y-axis for `mortgage_payment`
#   ) +
#  
# scale_fill_viridis(
#     alpha = 0.8,
#     discrete = TRUE,
#     option = "C",
#     aesthetics = "fill",
#     labels=c("Средна цена на апартамент","Вноска по ипотека")
#   )+
#   labs(
#     title = "Средна цена на апартамент и средна вноска по ипотека",
#     x = "",
#     fill = ""
#   ) +
#  customTheme
```




```{r}
growth_df2 <- data%>%
  pivot_longer(cols=c(average_price_condo,
                      mortgage_payment,
                     ),
               names_to = 'category',
               values_to = 'value'
  )%>%
  mutate(
    # Scale `average_price_condo` to align with the primary y-axis (0–100)
    scaled_value = ifelse(category == "average_price_condo", value, value *200)
  )
# Plot with dual y-axes and line chart for `average_price_condo`
ggplot(growth_df2, aes(x = factor(year))) +
  # Bar chart for `mortgage_payment`
  geom_bar(
    data = growth_df2 %>% filter(category == "average_price_condo"),
    aes(y = scaled_value, fill = category),
    stat = "identity",
    position = position_dodge2(width = 0.1, preserve = "single")
  ) +
  # Line chart for `mortgage_payment`
  geom_line(
    data = growth_df2 %>% filter(category == "mortgage_payment"),
    aes(y = scaled_value, color = category, group = 1),
    size = 1.2
  ) +
  # Optional: Add points to the line chart
  geom_point(
    data = growth_df2 %>% filter(category == "mortgage_payment"),
    aes(y = scaled_value, color = category),
    size = 2
  ) +
  scale_x_discrete(
    breaks = c(
      '2008-12-31', '2009-12-31', '2010-12-31', '2011-12-31', '2012-12-31',
      '2013-12-31', '2014-12-31', '2015-12-31', '2016-12-31', '2017-12-31',
      '2018-12-31', '2019-12-31', '2020-12-31', '2021-12-31', '2022-12-31',
      '2023-12-31', '2024-03-31', '2024-06-30'
    ),
    expand = expansion(mult = c(0.01, 0.02)) # Ensure space for the quarterly points
  ) +
  scale_y_continuous(
    name = "Средна цена на апартамент €",  # Primary y-axis for `average_price_condo`
    limits = c(0,200000),
    sec.axis = sec_axis(~ . / 200,
                        name = "Плащане по ипотека €",
                       )  # Secondary y-axis for `mortgage_payment`
  ) +
 scale_color_viridis(
    alpha = 0.8,
    discrete = TRUE,
    option = "C",
    aesthetics = "color",
    labels=c("Вноска по ипотека")
  )+
 scale_fill_viridis(
    alpha = 0.8,
    discrete = TRUE,
    option = "C",
    aesthetics = "fill",
    labels=c("Средна цена на апартамент")
  )+
  labs(
    title = "Цена и средно плащане по ипотека в € ",
    x = "",
    fill = "",
    color = ""
  ) +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.background = element_rect(fill = NA, color = NA),
    axis.title.y.right = element_text(color = "black")  # Secondary axis label visibility
  )+
   guides(
    fill = guide_legend(ncol = 1),  # For bar chart legend
    color = guide_legend(ncol = 1)  # For line chart legend
  ) +
  customTheme

```

Горната графика показва огромното значение на лихвите по ипотеки за достъпността на жилищните имоти. Вижда се че през 2008 и 2009 година, въпреки значително по-ниските цени на жилищата спрямо 2023 или 2024 година, вноската по ипотека би била аналогична. Единствено заради доста по-високите лихви. Така достъпността на даден имот е зависим както от цената на имота, така и от лихвите. И всеки фактор, който е възможно да повиши значително лихвите, може да окаже и силно негативно влияние на цените на имотите. Като при това не, за да ги направи по-достъпни.

```{r}
# Prepare data for plotting
salary_mortgage <- data %>%
  pivot_longer(
    cols = c(mortgage_payment_real_prices, household_net),
    names_to = 'category',
    values_to = 'income'
  )

# Line chart data for `mortgage_payment_real_prices_as_percent_houshold_income`
line_data <- data %>%
  select(year, mortgage_payment_real_prices_as_percent_houshold_income) %>%
  mutate(percentage = mortgage_payment_real_prices_as_percent_houshold_income * 100)

# Base plot
ggplot(salary_mortgage, aes(x = factor(year))) +
  # Bar chart for `mortgage_payment_real_prices` and `household_net`
  geom_bar(
    aes(y = income, fill = category),
    stat = "identity",
    position = position_dodge2(width = 0.1, preserve = "single"),
  ) +
  # Line chart for `mortgage_payment_real_prices_as_percent_houshold_income`
  geom_line(
    data = line_data,
    aes(y = percentage * (5000 / 150), color = "Процент на ипотека от среден доход на домакинство", group = 1),
    size = 1.2
  ) +
  geom_point(
    data = line_data,
    aes(y = percentage * (5000 / 150), color = "Процент на ипотека от среден доход на домакинство"),
    size = 2
  ) +
  # X-axis formatting
  scale_x_discrete(
    breaks = c(
      '2008-12-31', '2009-12-31', '2010-12-31', '2011-12-31', '2012-12-31',
      '2013-12-31', '2014-12-31', '2015-12-31', '2016-12-31', '2017-12-31',
      '2018-12-31', '2019-12-31', '2020-12-31', '2021-12-31', '2022-12-31',
      '2023-12-31', '2024-03-31', '2024-06-30'
    ),
    expand = expansion(mult = c(0.01, 0.02))
  ) +
  # Primary and secondary y-axes
  scale_y_continuous(
    name = "Доход на домакинство и ипотека в лева",  # Primary y-axis for income
    sec.axis = sec_axis(~ . / (5000 / 150), name = "Процент на ипотека от среден доход на домакинство",
                        breaks = c(0,10,20,30,40,50,60,70,80,90,100,110,120,130,140,150)),
    
  ) +
 scale_color_viridis(
    alpha = 0.8,
    discrete = TRUE,
    option = "C",
    aesthetics = "color",
    labels=c("Процент на ипотека от среден доход на домакинство")
  )+
 scale_fill_viridis(
    alpha = 0.8,
    discrete = TRUE,
    option = "C",
    aesthetics = "fill",
    labels=c("Доход на домакинство лв.","Ипотека лв.")
  )+
 
  labs(
    title = "Доход на домакинство и ипотечно плащане",
    x = "",
    fill = "",
    color = ""
  ) +
   guides(
    fill = guide_legend(ncol = 1),  # For bar chart legend
    color = guide_legend(ncol = 1)  # For line chart legend
  ) +
  # Theme adjustments
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.background = element_rect(fill = NA, color = NA),
   
  )+
  customTheme

```

*Тъй като типичния купувач на основно жилище за живеене е семейство, то в горната графика са използвани средни доходи на домакинство. Допускането за изчисленията са семейство с двама работещи на средна за София заплата, като е взета нетната заплата.*

Спадът на лихвите и ръстът на доходите, значително изпреварващ ръста в цените на недвижимите имоти, прави недвижимите имоти все по-достъпни. Дори значителният растеж на цените на имотите след пандемията не успява да попречи на този дългосрочен тренд за все по достъпни през ипотека жилища. 

От 2018 година насам, средната вноска по ипотека за средно жилище е трайно в нискорисковите под 30% от нетните доходи на домакинство. През 2008 и 2009 година жилище е било възможно да се купи само от семейства с доходи много над средните. Нещата се променят леко след спадът в цените на имотите през годините на банкова криза, когато доходите все пак продължават да нарастват, но до 2017 година едно семейство е трябвало пак да получава поне два пъти средните доходи за София, за да може да си купи среден апартамент. 

Това рязко се променя през последните пет години, като реално всяко домакинство с двама работещи със средни доходи вече може да намери имот, за който да е във възможностите му да плаща вноски по ипотека. 

Тази графика ясно показва, че не само, че няма балон в цените на имотите, но всъщност през последните 4 години имотите са най-евтини - измерени спрямо доходите - за периода. Тъй като няма достатъчни данни от предходни години е трудно да се направи генерален извод, че сега имотите са най-евтини. Но като се има в предвид изключителното нежелание на банките да кредитират през 90 те години и ниските доходи и високи лихви в началото на 21 век, то може без особено залитане в оптимизъм, да се предполага, че почти никога в близката история на България не е било толкова достъпно за средно домакинство да осъществи мечтата си за свой дом.


При подобна силна връзка между доходи, лихви и цена на недвижими имоти е възможно да се изведе теоретична цена на имотите. Конкретните изчисления за долната графика са направени като се взима в предвид доходът на домакинство за съответната година, лихвата по ипотечни кредити и 30% праг от доходите, като норма на относително ниско рискова ипотека.

Получената цена на апартамент е теоретичната реалистична цена, получена от горните фактори.

```{r}
prices <- data%>%
  pivot_longer(cols=c(average_price_condo,
                      `estimated_price_30%_morgage`,
                      ),
               names_to = 'category',
               values_to = 'price'
  )

ggplot(prices, aes(x = factor(year), y = price, fill = category)) +
  geom_bar(stat = "identity",
           position = position_dodge2(width=0.1,  preserve = "single")) +
  scale_x_discrete(
    breaks = c('2008-12-31','2009-12-31','2010-12-31','2011-12-31','2012-12-31',
               '2013-12-31','2014-12-31',
               '2015-12-31','2016-12-31','2017-12-31',
               '2018-12-31','2019-12-31','2020-12-31',
               '2021-12-31','2022-12-31','2023-12-31',
               '2024-03-31','2024-06-30'),
    expand = expansion(mult = c(0.01, 0.02)) # Ensure space for the quarterly points
  ) +
  scale_fill_viridis(
    alpha = 0.8,
    discrete = TRUE,
    option = "C",
    aesthetics = "fill",
    labels=c("Средна цена на апартамент - пазарна","Средна цена на апартамент - според възможната ипотека")
  )+
  labs(
    title = "Цени на апартаменти и изчислена цена на апартаменти",
    x = "",
    y = "Евро",
    fill = "",
    color = ""
  )+
   guides(
    fill = guide_legend(ncol = 1),  # For bar chart legend
    color = guide_legend(ncol = 1)  # For line chart legend
  ) +
  # scale_y_continuous(labels = percent) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        panel.background = element_rect(fill = NA, color = NA))+
  customTheme
```

Графиката показва, че цената на имотите към момента е много далеч от балон. Пазарната цена през последните 4 години е много близко до теоретичната цена изведена от средните доходи. Всичко това отхвърля доста стабилно възможността в момента цените на имотите да се намират в ирационална фаза или дори да се приближават до балон. 

### Какво може да промени тази картина

На първо място сериозен ръст на несигурността в икономиката силно ще ограничи желанието на банките да кредитират и от там и е възможен сериозен спад на имотите. Това се наблюдава през периода 2008 - 2015 и е напълно възможно пак да се случи. Както поради някаква световна криза така и поради вътрешни фактори, като например отказ от влизане в еврозоната и съответно липса на защита на банките при някакво сътресение.

Евентуално вдигане на безработицата също силно би могло да повлие на цените на имотите. Несигурността за работното място прави банките по-малко склонни да кредитират, а и хората доста ще се поколебаят дали да вземат дългосрочна ипотека. Особено силно ще се отрази на имотите, ако тази безработица се появява в относително добре платени сектори, като IT, финанси или енергия. 

Друг възможен проблем би бил рязкото вдигане на лихвените проценти. Това също е възможно да се случи дори изцяло поради външи фактори, като по-висока инфлация в САЩ или еврозоната. Тъй като финансовите пазари са скачени съдове, неочаквани промени на едно място засягат всички. 

Все пак, към момента никой от тези негативни сценарии не изглежда вероятен в близко бъдеще. Така изводът, че цените на имотите са не само реални, но и дори с висока достъпност може да се приеме като доминиращ към момента. 